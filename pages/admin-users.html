<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Management - Inventory Management System</title>
    <link rel="stylesheet" href="../styles/styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">
                    <div class="sidebar-logo-icon">üì¶</div>
                    <div>
                        <div class="sidebar-logo-text">Inventory System</div>
                        <div class="sidebar-logo-subtitle">Inventory Management</div>
                    </div>
                </div>
            </div>

            <nav class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-section-title">Overview</div>
                    <a href="../index.html" class="nav-item">
                        <span class="nav-item-icon">üìä</span>
                        <span>Dashboard</span>
                    </a>
                </div>

                <div class="nav-section">
                    <div class="nav-section-title">Core Business</div>
                    <a href="../pages/products.html" class="nav-item">
                        <span class="nav-item-icon">üè∑Ô∏è</span>
                        <span>Products</span>
                        <span class="nav-item-badge" id="products-badge" style="display: none;">0</span>
                    </a>
                    <a href="../pages/inbound.html" class="nav-item">
                        <span class="nav-item-icon">üì•</span>
                        <span>Inbound</span>
                        <span class="nav-item-badge" id="inbound-badge" style="display: none;">0</span>
                    </a>
                    <a href="../pages/outbound.html" class="nav-item">
                        <span class="nav-item-icon">üì§</span>
                        <span>Outbound</span>
                        <span class="nav-item-badge" id="outbound-badge" style="display: none;">0</span>
                    </a>
                    <a href="../pages/inventory.html" class="nav-item">
                        <span class="nav-item-icon">üìã</span>
                        <span>Inventory</span>
                    </a>
                </div>

                <div class="nav-section">
                    <div class="nav-section-title">Reports & Analytics</div>
                    <a href="../pages/profit.html" class="nav-item">
                        <span class="nav-item-icon">üìà</span>
                        <span>Gross Profit</span>
                    </a>
                </div>

                <div class="nav-section">
                    <div class="nav-section-title">Administration</div>
                    <a href="../pages/admin-users.html" class="nav-item active">
                        <span class="nav-item-icon">üë•</span>
                        <span>User Management</span>
                    </a>
                </div>
            </nav>

            <div class="sidebar-footer">
                <div class="user-profile">
                    <div class="user-avatar" id="userAvatar">-</div>
                    <div class="user-info">
                        <div class="user-name" id="userName">Loading...</div>
                        <div class="user-role" id="userRole">-</div>
                    </div>
                    <button onclick="handleLogout()" style="background: none; border: none; cursor: pointer; color: var(--gray-400);" title="Logout">üö™</button>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Header -->
            <header class="header">
                <div class="header-left">
                    <h1 class="header-title">User Management</h1>
                </div>
                <div class="header-right">
                    <button class="btn btn-primary" onclick="showAddUserModal()">
                        + Add User
                    </button>
                </div>
            </header>

            <!-- Page Content -->
            <div class="page-content">
                <!-- Info Alert -->
                <div class="alert alert-info" style="margin-bottom: 24px;">
                    <span class="alert-icon">‚ÑπÔ∏è</span>
                    <div class="alert-content">
                        <div class="alert-text">As an admin, you can create new user accounts. Users will log in using their username and password.</div>
                    </div>
                </div>

                <!-- Users Table -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">All Users</h3>
                        <button class="btn btn-ghost btn-sm" onclick="loadUsers()">Refresh</button>
                    </div>
                    <div class="card-body" style="padding: 0;">
                        <table class="data-table" id="usersTable">
                            <thead>
                                <tr>
                                    <th>User</th>
                                    <th>Username</th>
                                    <th>Email</th>
                                    <th>Role</th>
                                    <th>Created</th>
                                    <th style="text-align: right;">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="usersTableBody">
                                <tr>
                                    <td colspan="6" style="text-align: center; padding: 40px;">Loading users...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Add User Modal -->
    <div class="modal-overlay" id="addUserModal" style="display: none;">
        <div class="modal" style="max-width: 520px;">
            <div class="modal-header">
                <h3 class="modal-title">Add New User</h3>
                <button class="modal-close" onclick="hideAddUserModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="addUserError" class="alert alert-error" style="display: none; margin-bottom: 16px;">
                    <span class="alert-icon">!</span>
                    <div class="alert-content">
                        <div class="alert-text" id="addUserErrorText"></div>
                    </div>
                </div>
                <div id="addUserSuccess" class="alert alert-success" style="display: none; margin-bottom: 16px;">
                    <span class="alert-icon">&#10003;</span>
                    <div class="alert-content">
                        <div class="alert-text">User created successfully!</div>
                    </div>
                </div>
                <form id="addUserForm" onsubmit="handleAddUser(event)">
                    <div class="form-group">
                        <label class="form-label">Display Name *</label>
                        <input type="text" class="form-control" id="newDisplayName" placeholder="e.g., John Smith" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Username *</label>
                        <input type="text" class="form-control" id="newUsername" placeholder="e.g., johnsmith" required pattern="[a-zA-Z0-9_]+" title="Only letters, numbers, and underscores">
                        <small style="color: var(--gray-500); font-size: 0.75rem;">Usernames must be unique and can only contain letters, numbers, and underscores.</small>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Email *</label>
                        <input type="email" class="form-control" id="newEmail" placeholder="john@example.com" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Role *</label>
                        <select class="form-control" id="newRole" required>
                            <option value="">Select role...</option>
                            <option value="admin">Admin - Full access</option>
                            <option value="staff">Staff - Basic operations</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Password *</label>
                        <input type="password" class="form-control" id="newPassword" placeholder="At least 6 characters" required minlength="6">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Confirm Password *</label>
                        <input type="password" class="form-control" id="newConfirmPassword" placeholder="Confirm password" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="hideAddUserModal()">Cancel</button>
                <button type="submit" form="addUserForm" class="btn btn-primary" id="addUserBtn">Create User</button>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal-overlay" id="deleteModal" style="display: none;">
        <div class="modal" style="max-width: 400px;">
            <div class="modal-header">
                <h3 class="modal-title">Delete User</h3>
                <button class="modal-close" onclick="hideDeleteModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete user <strong id="deleteUserName"></strong>?</p>
                <p style="color: var(--error-500); font-size: 0.875rem; margin-top: 8px;">This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="hideDeleteModal()">Cancel</button>
                <button type="button" class="btn btn-primary" style="background: var(--error-500);" onclick="confirmDelete()" id="confirmDeleteBtn">Delete</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { requireAdmin, logout, getAllUsers, createUser, deleteUserData, getCurrentUserData, loginWithUsername, storeUserLocally } from '../js/auth.js';
        import { auth } from '../js/firebase-config.js';

        let currentUser = null;
        let userToDelete = null;
        let adminCredentials = null;

        // Check admin access on page load
        async function init() {
            try {
                currentUser = await requireAdmin('../index.html');
                updateUserDisplay(currentUser);
                loadUsers();
            } catch (error) {
                console.error('Auth error:', error);
            }
        }

        init();

        function updateUserDisplay(user) {
            if (user) {
                document.getElementById('userAvatar').textContent = user.displayName ? user.displayName.charAt(0).toUpperCase() : 'U';
                document.getElementById('userName').textContent = user.displayName || 'User';
                document.getElementById('userRole').textContent = user.role === 'admin' ? 'Administrator' : 'Staff';
            }
        }

        window.loadUsers = async function() {
            const tbody = document.getElementById('usersTableBody');
            tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 40px;">Loading users...</td></tr>';

            const result = await getAllUsers();

            if (result.success) {
                if (result.users.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 40px;">No users found</td></tr>';
                } else {
                    tbody.innerHTML = result.users.map(user => `
                        <tr>
                            <td>
                                <div style="display: flex; align-items: center; gap: 12px;">
                                    <div class="user-avatar" style="width: 36px; height: 36px; font-size: 0.875rem;">${user.displayName ? user.displayName.charAt(0).toUpperCase() : 'U'}</div>
                                    <span>${user.displayName || 'Unnamed'}</span>
                                </div>
                            </td>
                            <td><span class="sku-display">${user.username}</span></td>
                            <td>${user.email}</td>
                            <td><span class="badge ${user.role === 'admin' ? 'badge-info' : 'badge-secondary'}">${user.role === 'admin' ? 'Admin' : 'Staff'}</span></td>
                            <td>${user.createdAt ? formatDate(user.createdAt) : 'N/A'}</td>
                            <td style="text-align: right;">
                                ${user.uid !== auth.currentUser?.uid ? `
                                    <button class="btn btn-ghost btn-sm" onclick="showDeleteModal('${user.uid}', '${user.displayName}')" style="color: var(--error-500);">Delete</button>
                                ` : '<span style="color: var(--gray-400); font-size: 0.8125rem;">Current user</span>'}
                            </td>
                        </tr>
                    `).join('');
                }
            } else {
                tbody.innerHTML = `<tr><td colspan="6" style="text-align: center; padding: 40px; color: var(--error-500);">Error: ${result.error}</td></tr>`;
            }
        };

        function formatDate(timestamp) {
            if (!timestamp) return 'N/A';
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
        }

        window.handleLogout = async function() {
            const result = await logout();
            if (result.success) {
                window.location.href = '../pages/login.html';
            }
        };

        window.showAddUserModal = function() {
            document.getElementById('addUserModal').style.display = 'flex';
            document.getElementById('addUserError').style.display = 'none';
            document.getElementById('addUserSuccess').style.display = 'none';
            document.getElementById('addUserForm').reset();
            document.getElementById('addUserBtn').disabled = false;
            document.getElementById('addUserBtn').textContent = 'Create User';
        };

        window.hideAddUserModal = function() {
            document.getElementById('addUserModal').style.display = 'none';
        };

        window.handleAddUser = async function(event) {
            event.preventDefault();

            const displayName = document.getElementById('newDisplayName').value.trim();
            const username = document.getElementById('newUsername').value.trim();
            const email = document.getElementById('newEmail').value.trim();
            const role = document.getElementById('newRole').value;
            const password = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('newConfirmPassword').value;

            const errorDiv = document.getElementById('addUserError');
            const errorText = document.getElementById('addUserErrorText');
            const successDiv = document.getElementById('addUserSuccess');
            const submitBtn = document.getElementById('addUserBtn');

            // Validate passwords
            if (password !== confirmPassword) {
                errorText.textContent = 'Passwords do not match';
                errorDiv.style.display = 'flex';
                return;
            }

            submitBtn.disabled = true;
            submitBtn.textContent = 'Creating...';
            errorDiv.style.display = 'none';

            // Store admin credentials before creating user
            // After creating a user, Firebase signs in as the new user
            // We need the admin's password to re-authenticate
            const adminPassword = prompt('Please enter your admin password to confirm user creation:');
            if (!adminPassword) {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Create User';
                return;
            }

            const adminUsername = currentUser.username;

            try {
                const result = await createUser(username, email, password, role, displayName);

                if (result.success) {
                    // Re-authenticate as admin
                    const loginResult = await loginWithUsername(adminUsername, adminPassword);
                    if (loginResult.success) {
                        storeUserLocally(loginResult.user, true);
                        currentUser = loginResult.user;
                    }

                    successDiv.style.display = 'flex';
                    document.getElementById('addUserForm').reset();

                    // Reload users list
                    loadUsers();

                    // Hide modal after 1.5 seconds
                    setTimeout(() => {
                        hideAddUserModal();
                    }, 1500);
                } else {
                    errorText.textContent = result.error;
                    errorDiv.style.display = 'flex';
                }
            } catch (error) {
                errorText.textContent = error.message || 'An error occurred';
                errorDiv.style.display = 'flex';
            }

            submitBtn.disabled = false;
            submitBtn.textContent = 'Create User';
        };

        window.showDeleteModal = function(uid, name) {
            userToDelete = uid;
            document.getElementById('deleteUserName').textContent = name;
            document.getElementById('deleteModal').style.display = 'flex';
        };

        window.hideDeleteModal = function() {
            document.getElementById('deleteModal').style.display = 'none';
            userToDelete = null;
        };

        window.confirmDelete = async function() {
            if (!userToDelete) return;

            const btn = document.getElementById('confirmDeleteBtn');
            btn.disabled = true;
            btn.textContent = 'Deleting...';

            const result = await deleteUserData(userToDelete);

            if (result.success) {
                loadUsers();
                hideDeleteModal();
            } else {
                alert('Error: ' + result.error);
            }

            btn.disabled = false;
            btn.textContent = 'Delete';
        };

        // Close modals when clicking outside
        document.getElementById('addUserModal').addEventListener('click', function(e) {
            if (e.target === this) hideAddUserModal();
        });
        document.getElementById('deleteModal').addEventListener('click', function(e) {
            if (e.target === this) hideDeleteModal();
        });
    </script>
</body>
</html>
