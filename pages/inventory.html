<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventory - Inventory Management System</title>
    <link rel="stylesheet" href="../styles/styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">
                    <div class="sidebar-logo-icon">üì¶</div>
                    <div>
                        <div class="sidebar-logo-text">Inventory System</div>
                        <div class="sidebar-logo-subtitle">Inventory Management</div>
                    </div>
                </div>
            </div>

            <nav class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-section-title">Overview</div>
                    <a href="../index.html" class="nav-item">
                        <span class="nav-item-icon">üìä</span>
                        <span>Dashboard</span>
                    </a>
                </div>

                <div class="nav-section">
                    <div class="nav-section-title">Core Business</div>
                    <a href="../pages/products.html" class="nav-item">
                        <span class="nav-item-icon">üè∑Ô∏è</span>
                        <span>Products</span>
                        <span class="nav-item-badge" id="products-badge" style="display: none;">0</span>
                    </a>
                    <a href="../pages/inbound.html" class="nav-item">
                        <span class="nav-item-icon">üì•</span>
                        <span>Inbound</span>
                        <span class="nav-item-badge" id="inbound-badge" style="display: none;">0</span>
                    </a>
                    <a href="../pages/outbound.html" class="nav-item">
                        <span class="nav-item-icon">üì§</span>
                        <span>Outbound</span>
                        <span class="nav-item-badge" id="outbound-badge" style="display: none;">0</span>
                    </a>
                    <a href="../pages/inventory.html" class="nav-item active">
                        <span class="nav-item-icon">üìã</span>
                        <span>Inventory</span>
                    </a>
                </div>

                <div class="nav-section">
                    <div class="nav-section-title">Reports & Analytics</div>
                    <a href="../pages/profit.html" class="nav-item">
                        <span class="nav-item-icon">üìà</span>
                        <span>Gross Profit</span>
                    </a>
                </div>
            </nav>

            <div class="sidebar-footer">
                <div class="user-profile">
                    <div class="user-avatar" id="userAvatar">-</div>
                    <div class="user-info">
                        <div class="user-name" id="userName">Loading...</div>
                        <div class="user-role" id="userRole">-</div>
                    </div>
                    <button id="logoutBtn" style="background: none; border: none; cursor: pointer; color: var(--gray-400);" title="Logout">üö™</button>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Header -->
            <header class="header">
                <div class="header-left">
                    <div class="breadcrumb">
                        <a href="../index.html">Home</a>
                        <span class="breadcrumb-separator">/</span>
                        <span class="breadcrumb-current">Inventory</span>
                    </div>
                </div>
                <div class="header-right">
                    <div class="header-search">
                        <span class="header-search-icon">üîç</span>
                        <input type="text" placeholder="Search products, SKU...">
                    </div>
                    <button class="header-icon-btn">
                        <span>üîî</span>
                        <span class="badge"></span>
                    </button>
                </div>
            </header>

            <!-- Page Content -->
            <div class="page-content">
                <!-- Page Header -->
                <div class="page-header">
                    <div>
                        <h1 class="page-title">Inventory</h1>
                        <p class="page-subtitle">View inventory summary and batch details</p>
                    </div>
                    <div style="display: flex; gap: 12px;">
                        <button class="btn btn-secondary">
                            <span>üì•</span>
                            Export Inventory
                        </button>
                        <button class="btn btn-secondary">
                            <span>üñ®Ô∏è</span>
                            Print Count Sheet
                        </button>
                    </div>
                </div>

                <!-- Inventory Summary -->
                <div class="inventory-summary">
                    <div class="summary-item">
                        <div class="summary-value" id="summaryProductTypes">0</div>
                        <div class="summary-label">Product Types</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-value" id="summaryTotalStock">0</div>
                        <div class="summary-label">Total Stock Quantity</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-value" id="summaryTotalCost">$0</div>
                        <div class="summary-label">Total Inventory Cost</div>
                    </div>
                </div>

                <!-- Tabs -->
                <div class="tabs">
                    <button class="tab active" id="tabSummary" onclick="switchTab('summary')">Stock Summary</button>
                    <button class="tab" id="tabAlerts" onclick="switchTab('alerts')">Stock Alerts <span class="badge badge-warning" style="margin-left: 6px;" id="alertsTabBadge">0</span></button>
                </div>

                <!-- Tab Content: Stock Summary -->
                <div id="summaryContent">
                <!-- Filter Bar -->
                <div class="card">
                    <div class="card-body" style="padding: 16px 24px;">
                        <div class="filter-bar" style="margin-bottom: 0;">
                            <div class="search-input">
                                <span class="icon">üîç</span>
                                <input type="text" placeholder="Search specification or part number..." class="form-control" style="padding-left: 40px;" id="tableSearch" oninput="applyFilters()">
                            </div>
                            <select class="form-control form-select filter-select" id="filterSeries" onchange="applyFilters()">
                                <option value="">All Series</option>
                                <option value="PM893">PM893</option>
                                <option value="PM897">PM897</option>
                                <option value="PM963">PM963</option>
                                <option value="PM1733">PM1733</option>
                                <option value="PM1735">PM1735</option>
                                <option value="PM9D3a">PM9D3a</option>
                            </select>
                            <select class="form-control form-select filter-select" id="filterStatus" onchange="applyFilters()">
                                <option value="">Stock Status</option>
                                <option value="normal">Normal</option>
                                <option value="low">Low Stock</option>
                                <option value="critical">Critical</option>
                            </select>
                            <button class="btn btn-secondary" onclick="resetFilters()">
                                <span>üîÑ</span>
                                Reset
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Inventory Table -->
                <div class="card" style="margin-top: 20px;">
                    <div class="card-header">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <h3 class="card-title">Stock Summary</h3>
                            <span class="badge badge-info" id="totalProducts">0 products</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <span style="font-size: 0.8125rem; color: var(--gray-500);" id="lastUpdated">Loading...</span>
                            <button class="btn btn-ghost btn-sm" onclick="loadData()">
                                <span>üîÑ</span>
                                Refresh
                            </button>
                        </div>
                    </div>
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Product Info</th>
                                    <th>Part Number</th>
                                    <th>Series</th>
                                    <th style="text-align: right;">Stock Qty</th>
                                    <th style="text-align: right;">Stock Cost</th>
                                    <th>Status</th>
                                    <th>Batches</th>
                                    <th style="width: 100px;">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="inventoryTableBody">
                                <tr>
                                    <td colspan="8" style="text-align: center; padding: 40px;">Loading inventory...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="card-footer">
                        <div class="pagination">
                            <div class="pagination-info" id="paginationInfo">
                                Showing 0 records
                            </div>
                        </div>
                    </div>
                </div>
                </div>

                <!-- Tab Content: Stock Alerts -->
                <div id="alertsContent" style="display: none;">
                    <div class="card" style="margin-top: 20px;">
                        <div class="card-header">
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <h3 class="card-title">Stock Alerts</h3>
                                <span class="badge badge-warning" id="alertsCount">0 items need attention</span>
                            </div>
                            <button class="btn btn-ghost btn-sm" onclick="loadData()">
                                <span>üîÑ</span>
                                Refresh
                            </button>
                        </div>
                        <div class="card-body" style="padding: 0;">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Product Info</th>
                                        <th>Part Number</th>
                                        <th>Series</th>
                                        <th style="text-align: right;">Available Stock</th>
                                        <th style="text-align: right;">Stock Value</th>
                                        <th>Status</th>
                                        <th style="width: 120px;">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="alertsTableBody">
                                    <tr>
                                        <td colspan="7" style="text-align: center; padding: 40px;">Loading alerts...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Batch Detail Modal -->
    <div class="modal-overlay" id="detailModal" style="display: none;">
        <div class="modal modal-lg">
            <div class="modal-header">
                <div>
                    <h3 class="modal-title">Batch Details</h3>
                    <div style="font-size: 0.875rem; color: var(--gray-500); margin-top: 4px;" id="detailSubtitle">
                        Loading...
                    </div>
                </div>
                <button class="modal-close" onclick="closeDetail()">‚úï</button>
            </div>
            <div class="modal-body" id="detailContent">
                <!-- Content will be dynamically loaded -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeDetail()">Close</button>
                <a href="inbound.html" class="btn btn-primary">
                    <span>üì•</span>
                    New Inbound
                </a>
            </div>
        </div>
    </div>

    <script type="module">
        import { db } from '../js/firebase-config.js';
        import {
            collection,
            getDocs,
            query,
            where,
            orderBy
        } from 'https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js';
        import { initPageAuth, handleLogout } from '../js/page-auth.js';

        let currentUser = null;
        let allInventory = [];
        let filteredInventory = [];
        let inboundRecords = [];
        let currentTab = 'summary';

        // Initialize page
        async function init() {
            currentUser = await initPageAuth();
            await loadData();
        }

        init();

        // Tab switching
        window.switchTab = function(tab) {
            currentTab = tab;

            // Update tab buttons
            document.getElementById('tabSummary').classList.toggle('active', tab === 'summary');
            document.getElementById('tabAlerts').classList.toggle('active', tab === 'alerts');

            // Update content visibility
            document.getElementById('summaryContent').style.display = tab === 'summary' ? 'block' : 'none';
            document.getElementById('alertsContent').style.display = tab === 'alerts' ? 'block' : 'none';
        };

        // Load all data
        window.loadData = async function() {
            await loadInventoryData();
            updateLastUpdated();
        };

        // Load inventory data from inbound and outbound collections
        async function loadInventoryData() {
            const tbody = document.getElementById('inventoryTableBody');
            tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 40px;">Loading inventory...</td></tr>';

            try {
                // Get all confirmed inbound records
                const inboundRef = collection(db, 'inbound');
                const inboundQuery = query(inboundRef, where('status', '==', 'confirmed'));
                const inboundSnapshot = await getDocs(inboundQuery);

                inboundRecords = [];
                const stockMap = {};

                inboundSnapshot.forEach((doc) => {
                    const data = { id: doc.id, ...doc.data() };
                    inboundRecords.push(data);

                    const key = data.partNumber;
                    if (!stockMap[key]) {
                        stockMap[key] = {
                            partNumber: data.partNumber,
                            specification: data.specification,
                            series: '',
                            totalInbound: 0,
                            totalOutbound: 0,
                            totalCost: 0,
                            batchCount: 0
                        };
                    }
                    stockMap[key].totalInbound += data.quantity;
                    stockMap[key].totalCost += data.quantity * data.unitPrice;
                    stockMap[key].batchCount++;
                });

                // Get all outbound records
                const outboundRef = collection(db, 'outbound');
                const outboundSnapshot = await getDocs(outboundRef);

                outboundSnapshot.forEach((doc) => {
                    const data = doc.data();
                    const key = data.partNumber;
                    if (stockMap[key]) {
                        stockMap[key].totalOutbound += data.quantity;
                    }
                });

                // Get product info for series
                const productsRef = collection(db, 'products');
                const productsSnapshot = await getDocs(productsRef);

                const productMap = {};
                productsSnapshot.forEach((doc) => {
                    const data = doc.data();
                    productMap[data.partNumber] = data;
                });

                // Calculate available stock and add product info
                allInventory = Object.values(stockMap).map(item => {
                    const product = productMap[item.partNumber] || {};
                    const availableStock = item.totalInbound - item.totalOutbound;
                    const stockCost = availableStock > 0 ? (item.totalCost / item.totalInbound) * availableStock : 0;

                    return {
                        ...item,
                        series: product.series || extractSeries(item.specification),
                        description: product.description || '',
                        availableStock: availableStock,
                        stockCost: stockCost,
                        avgCost: item.totalInbound > 0 ? item.totalCost / item.totalInbound : 0,
                        status: availableStock <= 0 ? 'out' : (availableStock < 20 ? 'critical' : (availableStock < 50 ? 'low' : 'normal'))
                    };
                }).filter(item => item.totalInbound > 0);

                // Sort by specification
                allInventory.sort((a, b) => a.specification.localeCompare(b.specification));

                applyFilters();
                updateSummary();
            } catch (error) {
                console.error('Error loading inventory:', error);
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 40px; color: var(--error-500);">Error loading inventory. Please try again.</td></tr>';
            }
        }

        // Extract series from specification (fallback)
        function extractSeries(specification) {
            const match = specification.match(/PM\d{3,4}[a-z]?/i);
            return match ? match[0].toUpperCase() : '-';
        }

        // Apply filters and render table
        window.applyFilters = function() {
            const searchTerm = document.getElementById('tableSearch').value.toLowerCase();
            const seriesFilter = document.getElementById('filterSeries').value;
            const statusFilter = document.getElementById('filterStatus').value;

            filteredInventory = allInventory.filter(item => {
                // Search filter
                if (searchTerm) {
                    const searchFields = [item.specification, item.partNumber, item.series].join(' ').toLowerCase();
                    if (!searchFields.includes(searchTerm)) return false;
                }

                // Series filter
                if (seriesFilter && item.series !== seriesFilter) return false;

                // Status filter
                if (statusFilter && item.status !== statusFilter) return false;

                return true;
            });

            renderTable();
        };

        // Reset filters
        window.resetFilters = function() {
            document.getElementById('tableSearch').value = '';
            document.getElementById('filterSeries').value = '';
            document.getElementById('filterStatus').value = '';
            applyFilters();
        };

        // Render table with filtered inventory
        function renderTable() {
            const tbody = document.getElementById('inventoryTableBody');

            if (filteredInventory.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 40px; color: var(--gray-500);">No inventory found</td></tr>';
                document.getElementById('totalProducts').textContent = '0 products';
                document.getElementById('paginationInfo').textContent = 'Showing 0 records';
                return;
            }

            tbody.innerHTML = filteredInventory.map(item => {
                const statusBadge = getStatusBadge(item.status, item.availableStock);
                const rowStyle = item.status === 'critical' ? 'style="background: var(--error-50);"' :
                                 (item.status === 'low' ? 'style="background: var(--warning-50);"' : '');
                const stockColor = item.status === 'critical' ? 'color: var(--error-600);' : '';

                return `
                    <tr ${rowStyle}>
                        <td>
                            <div style="font-weight: 500;">${escapeHtml(item.specification)}</div>
                            ${item.description ? `<div style="font-size: 0.8125rem; color: var(--gray-500);">${escapeHtml(item.description)}</div>` : ''}
                        </td>
                        <td><span class="sku-display">${escapeHtml(item.partNumber)}</span></td>
                        <td>${escapeHtml(item.series)}</td>
                        <td style="text-align: right; font-family: var(--font-family-mono); font-weight: 600; ${stockColor}">${item.availableStock.toLocaleString()}</td>
                        <td style="text-align: right; font-family: var(--font-family-mono);">$${item.stockCost.toLocaleString(undefined, {minimumFractionDigits: 2})}</td>
                        <td>${statusBadge}</td>
                        <td style="text-align: center;">${item.batchCount}</td>
                        <td>
                            <button class="btn btn-ghost btn-sm" onclick="showDetail('${item.partNumber}')">View Batches</button>
                        </td>
                    </tr>
                `;
            }).join('');

            document.getElementById('totalProducts').textContent = `${filteredInventory.length} products`;
            document.getElementById('paginationInfo').textContent = `Showing ${filteredInventory.length} records`;
        }

        // Get status badge HTML
        function getStatusBadge(status, qty) {
            if (status === 'critical' || qty <= 0) {
                return '<span class="badge badge-error">Critical</span>';
            } else if (status === 'low') {
                return '<span class="badge badge-warning">Low Stock</span>';
            }
            return '<span class="badge badge-success">Normal</span>';
        }

        // Update summary statistics
        function updateSummary() {
            const totalProducts = allInventory.length;
            const totalStock = allInventory.reduce((sum, item) => sum + item.availableStock, 0);
            const totalCost = allInventory.reduce((sum, item) => sum + item.stockCost, 0);

            document.getElementById('summaryProductTypes').textContent = totalProducts.toLocaleString();
            document.getElementById('summaryTotalStock').textContent = totalStock.toLocaleString();
            document.getElementById('summaryTotalCost').textContent = '$' + totalCost.toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 0});

            // Also update stock alerts
            updateStockAlerts();
        }

        // Update stock alerts table
        function updateStockAlerts() {
            // Filter for low stock and critical items (stock < 100)
            const alertItems = allInventory
                .filter(item => item.availableStock < 100 && item.availableStock > 0)
                .sort((a, b) => a.availableStock - b.availableStock);

            // Update badge counts
            const alertCount = alertItems.length;
            document.getElementById('alertsTabBadge').textContent = alertCount;
            document.getElementById('alertsTabBadge').style.display = alertCount > 0 ? 'inline-flex' : 'none';
            document.getElementById('alertsCount').textContent = `${alertCount} item${alertCount !== 1 ? 's' : ''} need attention`;

            // Render alerts table
            const tbody = document.getElementById('alertsTableBody');

            if (alertItems.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px; color: var(--success-600);">All stock levels are healthy!</td></tr>';
                return;
            }

            tbody.innerHTML = alertItems.map(item => {
                const statusBadge = getStatusBadge(item.status, item.availableStock);
                const rowStyle = item.status === 'critical' ? 'style="background: var(--error-50);"' :
                                 (item.status === 'low' ? 'style="background: var(--warning-50);"' : '');
                const stockColor = item.status === 'critical' ? 'color: var(--error-600);' : 'color: var(--warning-600);';

                return `
                    <tr ${rowStyle}>
                        <td>
                            <div style="font-weight: 500;">${escapeHtml(item.specification)}</div>
                            ${item.description ? `<div style="font-size: 0.8125rem; color: var(--gray-500);">${escapeHtml(item.description)}</div>` : ''}
                        </td>
                        <td><span class="sku-display">${escapeHtml(item.partNumber)}</span></td>
                        <td>${escapeHtml(item.series)}</td>
                        <td style="text-align: right; font-family: var(--font-family-mono); font-weight: 600; ${stockColor}">${item.availableStock.toLocaleString()}</td>
                        <td style="text-align: right; font-family: var(--font-family-mono);">$${item.stockCost.toLocaleString(undefined, {minimumFractionDigits: 2})}</td>
                        <td>${statusBadge}</td>
                        <td>
                            <a href="inbound.html" class="btn btn-primary btn-sm">
                                <span>üì•</span>
                                Restock
                            </a>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Update last updated timestamp
        function updateLastUpdated() {
            const now = new Date();
            const formatted = now.toISOString().slice(0, 16).replace('T', ' ');
            document.getElementById('lastUpdated').textContent = 'Last updated: ' + formatted;
        }

        // Show detail modal
        window.showDetail = async function(partNumber) {
            const item = allInventory.find(i => i.partNumber === partNumber);
            if (!item) return;

            // Get inbound batches for this product
            const batches = inboundRecords.filter(r => r.partNumber === partNumber);
            batches.sort((a, b) => (a.inboundDate > b.inboundDate ? 1 : -1));

            document.getElementById('detailSubtitle').innerHTML = `
                ${escapeHtml(item.specification)} ¬∑ <span class="sku-display" style="font-size: 0.75rem;">${escapeHtml(item.partNumber)}</span>
            `;

            document.getElementById('detailContent').innerHTML = `
                <!-- Summary -->
                <div class="inventory-summary" style="margin-bottom: 24px;">
                    <div class="summary-item">
                        <div class="summary-value">${item.batchCount}</div>
                        <div class="summary-label">Stock Batches</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-value">${item.availableStock.toLocaleString()}</div>
                        <div class="summary-label">Available Stock</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-value">$${item.stockCost.toLocaleString(undefined, {minimumFractionDigits: 2})}</div>
                        <div class="summary-label">Stock Value</div>
                    </div>
                </div>

                <!-- Batch Table -->
                ${batches.length > 0 ? `
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Batch</th>
                                <th>Inbound Date</th>
                                <th style="text-align: right;">Quantity</th>
                                <th style="text-align: right;">Unit Cost</th>
                                <th style="text-align: right;">Batch Cost</th>
                                <th>Condition</th>
                                <th>Warehouse</th>
                                <th>DC/Origin</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${batches.map((batch, index) => `
                                <tr>
                                    <td style="font-weight: 500;">#${String(index + 1).padStart(3, '0')}</td>
                                    <td>${batch.inboundDate}</td>
                                    <td style="text-align: right; font-family: var(--font-family-mono);">${batch.quantity.toLocaleString()}</td>
                                    <td style="text-align: right; font-family: var(--font-family-mono);">$${batch.unitPrice.toFixed(2)}</td>
                                    <td style="text-align: right; font-family: var(--font-family-mono);">$${(batch.quantity * batch.unitPrice).toLocaleString(undefined, {minimumFractionDigits: 2})}</td>
                                    <td><span class="badge badge-info">${escapeHtml(batch.condition)}</span></td>
                                    <td>${escapeHtml(batch.warehouse)}</td>
                                    <td>${escapeHtml(batch.origin)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>

                    ${batches.some(b => b.notes) ? `
                        <div style="margin-top: 24px;">
                            <h4 style="font-size: 0.875rem; font-weight: 600; margin-bottom: 12px;">Batch Notes</h4>
                            <div style="background: var(--gray-50); border-radius: var(--radius-md); padding: 16px;">
                                ${batches.filter(b => b.notes).map((batch, index) => `
                                    <div style="margin-bottom: 12px;">
                                        <div style="font-size: 0.8125rem; color: var(--gray-500); margin-bottom: 4px;">Batch #${String(batches.indexOf(batch) + 1).padStart(3, '0')} (${batch.inboundDate}):</div>
                                        <div style="font-size: 0.875rem; white-space: pre-wrap;">${escapeHtml(batch.notes)}</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                ` : '<p style="color: var(--gray-500); text-align: center; padding: 20px;">No inbound batches found.</p>'}
            `;

            document.getElementById('detailModal').style.display = 'flex';
        };

        // Close detail modal
        window.closeDetail = function() {
            document.getElementById('detailModal').style.display = 'none';
        };

        // Utility function
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Make logout available globally
        window.handleLogout = handleLogout;
    </script>
</body>
</html>
